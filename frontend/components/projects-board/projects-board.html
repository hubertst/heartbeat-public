<link rel="import" href="../socket-connection.html">

<dom-module id="hb-projects-board">
  <style>
    #projects-graph-wrapper, #project-artifacts-wrapper {
      display: block;
    }
    #projects-graph {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      justify-content: space-between;
      background-color: black;
      height: 156px;
    }
    #projects-graph-legend {
      display: flex;
      flex-grow: 2;
      background:
        url('../../icons/icon-legend-happy.png') top center no-repeat,
        url('../../icons/icon-legend-sleep.png') center center no-repeat,
        url('../../icons/icon-legend-unhappy.png') bottom center no-repeat;
      background-color: #565752;
      color: white;
      padding: 2em 0;
    }
    .project {
      display: flex;
      flex-grow: 1;
    }
    #project-artifacts {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      justify-content: space-between;
      background-color: black;
    }
    .project-artifact {
      padding: 2em 0;
      width: 20%;
      background-color: #A9E4CD;
      text-align: center;
    }
    .project-artifact img {
      margin-bottom: 30px;
      height: 90px;
    }
    value, description {
      display: block;
      text-align: center;
    }
    value {
      color: #ffffff;
    }
    description {
      color: #113738;
      font-size: 28px;
    }
  </style>

  <template>
    <div id="projects-graph-wrapper">
      <div id="projects-graph">
        <div id="projects-graph-legend"></div>
        <template is="dom-repeat" id="projects" items="{{projects}}" as="project">
          <template is="dom-if" if="{{ project.visible }}">
            <div class="project">{{ project.projectshortname }}</div>
          </template>
        </template>
      </div>
    </div>
    <div id="project-artifacts-wrapper">
      <div id="project-artifacts">
        <template is="dom-repeat" id="projectArtifact" items="{{projectArtifacts}}" as="artifact">
            <div class="project-artifact">
              <img src$="{{ artifact.icon }}" />
              <description>{{artifact.name}}</description>
            </div>
        </template>
      </div>
    </div>
    <socket-connection endpoint="projects"
                       on-data="onData">
  </template>

  <script>
    (function () {
      function getProjectInfo(projectsList, idx) {
        return [{
              name: 'Team Spirit',
              icon: valueIconsMap[projectsList[idx]['teamspirit']]
            }, {
              name: 'Client Mood',
              icon: valueIconsMap[projectsList[idx]['clientmood']]
            }, {
              name: 'Scrum daily',
              icon: valueIconsMap[projectsList[idx]['scrumdaily']]
            }, {
              name: 'Scrum planning',
              icon: valueIconsMap[projectsList[idx]['scrumplanning']]
            }, {
              name: 'Scrum retro',
              icon: valueIconsMap[projectsList[idx]['scrumplanning']]
            }
          ];
      };

      function projectEvaluation() {
        var projectsum = 0;
        var nonEmptyArguments = 0;
        var result = 0;
        for(var i = 0, j = arguments.length; i < j; i++) {
          if(arguments[i] !== '') {
            projectsum += parseInt(arguments[i], 10);
            nonEmptyArguments++;
          }
        }
        if (projectsum === 0 && nonEmptyArguments === 0) {
          result = 0;
        } else {
          if (projectsum/nonEmptyArguments > 0) {
            result = 1;
          } else if (projectsum/nonEmptyArguments < 0) {
            result = -1;
          } else {
            result = 0;
          }
        }
        return result;
      };

      function getProjects(projectsList, offset) {
        var projects = [];
        var visibleNum = 0;
        var visible = false;
        projectsList.forEach(function (el, idx) {
          if (visibleNum < 9) {
            visible = true;
          } else {
            visible = false;
          }
          
          visibleNum++;

          projects.push({
            'projectname': el.projectname,
            'projectshortname': el.projectshortname,
            'projectevaluation': projectEvaluation(el.teamspirit, el.clientmood, el.scrumdaily, el.scrumplanning,
                el.scrumplanning),
            'visible': visible
          });
        });
        return projects;
      }

      var valueIconsMap = {
        '-1': './icons/icon-emo-unhappy.png',
        '0': './icons/icon-emo-sleep.png',
        '1': './icons/icon-emo-happy.png',
        '': './icons/icon-cancel.png'
      };

      Polymer({
        is: 'hb-projects-board',
        onData: function (ev, data) {
          var projectsList = data.projectsList;
          var idx = 0;
          var that = this;
          that.projects = getProjects(projectsList, idx);
          that.projectArtifacts = getProjectInfo(projectsList, idx);
          idx++;

          setInterval(function () {
            that.projects = getProjects(projectsList, idx);
            that.projectArtifacts = getProjectInfo(projectsList, idx);
            idx++;
            if (idx > projectsList.length - 1) idx = 0;
          }, 1000);
        }
      });
    })();
  </script>
</dom-module>
